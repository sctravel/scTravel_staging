var dbPool = require('./createDBConnectionPool');
var tableNames = require('./tableNames');
var connection = dbPool.connection;
//var runQuery = dbPool.runQuery;
//var runQueryWithParams = dbPool.runQueryWithParams;


var callback = function(results) {
    console.log(results);
}


var errorHandler = function(err) {
    console.log(err);
}

//connection.query('CREATE database sctravel',errorHandler);
//connection.query('USE sctravel');
//connection.query('DROP TABLE t_tickets_sold',errorHandler);
//connection.query('DROP TABLE t_tickets_inventory',errorHandler);
//connection.query('DROP TABLE t_orders',errorHandler);
//connection.query('DROP TABLE t_scenery_spots',errorHandler);

connection.connect();


var dropTableSQLs=[];

var dropTableSQL1='DROP TABLE '+ tableNames.skuTable ;
var dropTableSQL2='DROP TABLE '+ tableNames.spotTable;
var dropTableSQL3='DROP TABLE '+ tableNames.ticketTable;
var dropTableSQL4='DROP TABLE '+ tableNames.routeTable;
var dropTableSQL5='DROP TABLE '+ tableNames.busTable;
var dropTableSQL6='DROP TABLE '+ tableNames.driverTable;
var dropTableSQL7='DROP TABLE '+ tableNames.offerTable;
var dropTableSQL8='DROP TABLE '+ tableNames.mappingTable;
var dropTableSQL9='DROP TABLE '+ tableNames.scheduleTable;
var dropTableSQL10='DROP TABLE '+ tableNames.customerTable
var dropTableSQL11='DROP TABLE '+ tableNames.orderTable;
var dropTableSQL12='DROP TABLE '+ tableNames.voucherTable;
var dropTableSQL13='DROP TABLE '+ tableNames.unitTable;

dropTableSQLs.push(dropTableSQL13);
dropTableSQLs.push(dropTableSQL12);
dropTableSQLs.push(dropTableSQL11);
dropTableSQLs.push(dropTableSQL10);
dropTableSQLs.push(dropTableSQL9);
dropTableSQLs.push(dropTableSQL8);
dropTableSQLs.push(dropTableSQL7);
dropTableSQLs.push(dropTableSQL6);
dropTableSQLs.push(dropTableSQL5);
dropTableSQLs.push(dropTableSQL4);
dropTableSQLs.push(dropTableSQL3);
dropTableSQLs.push(dropTableSQL2);
dropTableSQLs.push(dropTableSQL1);



//Table SC_SKUS
var createTableSQL1 = 'CREATE TABLE ' + tableNames.skuTable +
    ' ( sku_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' sku_type ENUM(\'Ticket\',\'Route\')  NOT NULL, ' +
    ' sku_description VARCHAR(127) ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ';

//Table SC_SCENERY_SPOTS
var createTableSQL2='CREATE TABLE ' + tableNames.spotTable +
    ' ( spot_id INT PRIMARY KEY AUTO_INCREMENT , ' +
    ' spot_name VARCHAR(127) NOT NULL, ' +
    ' spot_type VARCHAR(31), ' +
    ' longitude DECIMAL(20,6) NOT NULL, ' +
    ' latitude DECIMAL(20,6) NOT NULL, ' +
    ' city VARCHAR(63) , ' +
    ' address VARCHAR(255), ' +
    ' post_code VARCHAR(11), ' +
    ' phone VARCHAR(14),' +
    ' hours VARCHAR(31), ' +
    ' url VARCHAR(63),' + //static url page of this scenery spot
    ' is_scenery ENUM(\'Y\', \'N\') DEFAULT \'Y\' ,' +
    ' is_start ENUM(\'Y\', \'N\') DEFAULT \'Y\' ,' +
    ' creation_datetime TIMESTAMP default now(),' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, ' +
    ' UNIQUE(spot_name)  ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ';


//Table SC_SKU_TICKETS
var createTableSQL3= 'CREATE TABLE ' + tableNames.ticketTable +
    ' ( sku_id INT NOT NULL, ' +
    ' spot_id INT, ' +
    ' ticket_description VARCHAR(127),' +
    ' creation_datetime TIMESTAMP DEFAULT now(), ' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, ' +
    // ' created_by VARCHAR(15), ' +
    ' FOREIGN KEY tickets_f_key_sku (sku_id) REFERENCES SC_SKUS(sku_id) ON DELETE CASCADE  ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ';

//Table SC_SKU_ROUTES
var createTableSQL4= 'CREATE TABLE ' + tableNames.routeTable +
    ' ( sku_id INT NOT NULL, ' +
    ' departure_spot_id INT NOT NULL, ' +
    ' arrival_spot_id INT NOT NULL, ' +
    ' distance DECIMAL(10,3) , ' +
    ' travel_time_in_hours DECIMAL(10,3), ' +
    ' route_description VARCHAR(127), ' +
    ' creation_datetime TIMESTAMP DEFAULT now(), ' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, ' +
    ' UNIQUE(departure_spot_id, arrival_spot_id), ' +
    ' FOREIGN KEY routes_f_key_sku (sku_id) REFERENCES SC_SKUS(sku_id) ON DELETE CASCADE,  ' +
    ' FOREIGN KEY routes_f_key_depart_spot (departure_spot_id) REFERENCES SC_SCENERY_SPOTS(spot_id) ON DELETE CASCADE , ' +
    ' FOREIGN KEY routes_f_key_arrive_spot (arrival_spot_id) REFERENCES SC_SCENERY_SPOTS(spot_id) ON DELETE CASCADE   ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ';


//Table SC_BUS_INFO
var createTableSQL5='CREATE TABLE  ' + tableNames.busTable +
    ' ( bus_id INT PRIMARY KEY AUTO_INCREMENT,  ' +
    ' license_plate VARCHAR(15) NOT NULL, '+  //1 is paid, 2 is unpaid, 3 is expired or used
    ' capacity INT NOT NULL, ' +
    ' bus_brand VARCHAR(15), ' +
    ' bus_start_year INT, ' +
    ' bus_type VARCHAR(15), ' +
    ' in_service ENUM(\'Y\', \'N\') DEFAULT \'Y\' ,' +
    ' creation_datetime TIMESTAMP DEFAULT now(),' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, ' +
    ' UNIQUE(license_plate) ' +
    '  )ENGINE=InnoDB DEFAULT CHARSET=utf8  ';

//Table SC_DRIVER_INFO
var createTableSQL6= 'CREATE TABLE ' + tableNames.driverTable +
    ' ( driver_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' driver_name VARCHAR(15) NOT NULL, ' +
    ' driver_phone VARCHAR(11) NOT NULL, ' +
    ' driver_sex ENUM(\'M\',\'F\') DEFAULT \'M\' , ' +
    ' driver_age INT, ' +
    ' creation_datetime TIMESTAMP DEFAULT now(), ' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8  ';

//Table SC_OFFERS
var createTableSQL7='CREATE TABLE ' + tableNames.offerTable +
    ' ( offer_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' offer_name VARCHAR(63) NOT NULL, ' +
    ' offer_price DECIMAL(20,6) NOT NULL, ' +
    ' offer_description VARCHAR(255),' +
    ' creation_datetime TIMESTAMP DEFAULT now(),' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8  ';


//Table SC_SKU_OFFER_MAPPING
var createTableSQL8='CREATE TABLE ' + tableNames.mappingTable +
        ' ( offer_id INT NOT NULL, ' +
        ' sku_id INT NOT NULL, ' +
        ' sku_type ENUM(\'Ticket\',\'Route\') NOT NULL, ' +
        ' creation_time TIMESTAMP DEFAULT now(),' +
        ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,' +
        ' UNIQUE(offer_id,sku_id),  ' +
        ' FOREIGN KEY mapping_f_key_offer (offer_id) REFERENCES SC_OFFERS(offer_id) ON DELETE CASCADE, ' +
        ' FOREIGN KEY tickets_f_key_sku (sku_id) REFERENCES SC_SKUS(sku_id) ON DELETE CASCADE ' +
        ' )ENGINE=InnoDB DEFAULT CHARSET=utf8  ';

//Table SC_SCHEDULES
var createTableSQL9='CREATE TABLE ' + tableNames.scheduleTable +
    ' ( schedule_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' sku_id INT NOT NULL, ' +
    ' bus_id INT NOT NULL, ' +
    ' driver_id INT NOT NULL, ' +
    ' departure_time VARCHAR(5) NOT NULL, ' +
    ' arrival_time VARCHAR(5),' +
    ' schedule_date DATE DEFAULT NULL, ' + //Used in override, default is NULL
    ' creation_datetime TIMESTAMP DEFAULT now(), ' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, ' +
    ' FOREIGN KEY schedule_f_key_sku (sku_id) REFERENCES SC_SKU_ROUTES(sku_id) ON DELETE CASCADE, ' +
    ' FOREIGN KEY schedule_f_key_bus (bus_id) REFERENCES SC_BUS_INFO(bus_id) ON DELETE CASCADE, ' +
    ' FOREIGN KEY schedule_f_key_driver (driver_id) REFERENCES SC_DRIVER_INFO(driver_id) ON DELETE CASCADE ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8  ';


var createTableSQL10 = 'CREATE TABLE ' + tableNames.customerTable +
    ' ( customer_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' customer_name VARCHAR(31), ' +
    ' mobile_phone VARCHAR(12), ' +
    ' email VARCHAR(31), ' +
    ' is_registered ENUM(\'Y\',\'N\')  ' +  //LOGIN and PASSWORD?
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ';

var createTableSQL11 = 'CREATE TABLE ' + tableNames.orderTable +
    ' ( order_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' order_datetime TIMESTAMP DEFAULT now(), ' +
    ' customer_id INT, ' +
    ' total_order_amount DECIMAL(20,6) NOT NULL , ' +
    ' confirmation_code VARCHAR(15) NOT NULL, ' +
    ' order_status ENUM(\'1\',\'2\',\'3\',\'4\') DEFAULT \'1\', ' +   //1 is reserved (not paid), 2 is paid, 3 is cancelled
    ' description  VARCHAR(31), ' +
    ' creation_datetime TIMESTAMP DEFAULT now(), ' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, ' +
    ' FOREIGN KEY order_f_key_customer (customer_id) REFERENCES SC_CUSTOMERS(customer_id) ON DELETE CASCADE ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ';

var createTableSQL12='CREATE TABLE ' + tableNames.voucherTable +
    ' ( voucher_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' order_id INT NOT NULL, ' +
    ' offer_id INT NOT NULL, ' +
    ' sku_id INT NOT NULL, ' +
    ' schedule_id INT, ' + //only route has schedule, if the voucher only contain tickets or others (no route), schedule_id should be null
    ' quantity INT NOT NULL, ' +
    ' offer_quantity INT, ' +
    ' offer_subtotal_amount DECIMAL(20,6), ' +
    ' voucher_description VARCHAR(63), ' +
    ' creation_datetime TIMESTAMP DEFAULT now(), ' +
    ' last_updated_time TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, ' +
    ' FOREIGN KEY voucher_f_key_order (order_id) REFERENCES SC_ORDERS(order_id) ON DELETE CASCADE, ' +
    ' FOREIGN KEY voucher_f_key_offer (offer_id) REFERENCES SC_OFFERS(offer_id) ON DELETE CASCADE, ' +
    ' FOREIGN KEY voucher_f_key_sku (sku_id) REFERENCES SC_SKUS(sku_id) ON DELETE CASCADE, ' +
    ' FOREIGN KEY voucher_f_key_schedule (schedule_id) REFERENCES SC_SCHEDULES(schedule_id) ON DELETE CASCADE ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ';


var createTableSQL13='CREATE TABLE ' + tableNames.unitTable +
    ' ( unit_id INT PRIMARY KEY AUTO_INCREMENT, ' +
    ' order_id INT NOT NULL,' +
    ' offer_id INT NOT NULL, ' +
    ' offer_quantity INT NOT NULL, ' +
    ' offer_subtotal_amount DECIMAL(20,6) , ' +
    ' FOREIGN KEY voucher_f_key_order (order_id) REFERENCES SC_ORDERS(order_id) ON DELETE CASCADE, ' +
    ' FOREIGN KEY voucher_f_key_offer (offer_id) REFERENCES SC_OFFERS(offer_id) ON DELETE CASCADE ' +
    ' )ENGINE=InnoDB DEFAULT CHARSET=utf8 ' ;


var createTableSQLs=[];
createTableSQLs.push(createTableSQL1);
createTableSQLs.push(createTableSQL2);
createTableSQLs.push(createTableSQL3);
createTableSQLs.push(createTableSQL4);
createTableSQLs.push(createTableSQL5);
createTableSQLs.push(createTableSQL6);
createTableSQLs.push(createTableSQL7);
createTableSQLs.push(createTableSQL8);
createTableSQLs.push(createTableSQL9);
createTableSQLs.push(createTableSQL10);
createTableSQLs.push(createTableSQL11);
createTableSQLs.push(createTableSQL12);
createTableSQLs.push(createTableSQL13);


//Drop tables first
for(var i in dropTableSQLs) {
   // console.log(dropTableSQLs[i]);
    connection.query(dropTableSQLs[i],errorHandler);
}


//Create tables
for(var i in createTableSQLs) {
   // console.log(dropTableSQLs[i]);
    connection.query(createTableSQLs[i],errorHandler);
}



connection.end();


//connection.query('CREATE database sctravel',errorHandler);
//connection.query('USE sctravel');

//connection.query('DROP TABLE SC_SKUS',errorHandler);
//connection.query('DROP TABLE SC_SKU_TICKETS',errorHandler);
//connection.query('DROP TABLE SC_SKU_ROUTES',errorHandler);
//connection.query('DROP TABLE SC_SCENERY_SPOTS',errorHandler);


//connection.query('CREATE UNIQUE INDEX t_orders_IDX_0 on t_orders(confirmation_code)',errorHandler);