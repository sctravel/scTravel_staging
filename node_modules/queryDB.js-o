/**
 * Created by XiTU on 1/28/14.
 */
var mysql=require('mysql');
var confirm=require('./confirmationCodeGenerator');

var pool = mysql.createPool({
    host: 'localhost',//process.env.MYSQL_HOST,
    user: 'root',//process.env.MYSQL_USER,
    password: 'travel',
    database: 'sctravel',//process.env.MYSQL_DB,
    connectionLimit: 10,
    supportBigNumbers: true
});


var errorHandler = function(err) {
    console.log(err);
}

var spotTable = "t_scenery_spots";
var orderTable = "t_orders";
var ticketTable = "t_tickets_sold";
var inventoryTable = "t_tickets_inventory";

var runQueryWithParams = function(sql, params, callback) {
    pool.getConnection(function(err,conn){
      conn.query(sql,params, function(err,results){
          if(err){throw err;}
          callback(results);
          conn.release();
      })
    })
}

var runQuery = function(sql, callback) {
    pool.getConnection(function(err,conn){
        conn.query(sql, function(err,results){
            if(err){throw err;}
            callback(results);
            conn.release();
        })
    })
}
exports.getAllScenerySpots = function(callback) {

    var sql = " select * from "+spotTable+" order by city";
    runQuery(sql,callback);

}

exports.validateTicket = function(confirmationCode, spotId, date, callback) {
    //var sql = " select order_id from "+orderTable+" where confirmation_code="+confirmationCode;

    var sqlValidate = "update "+ticketTable+" set is_valid='N', redeem_datetime=sysdate() where confirmation_code=? and spot_Id=? and valid_date=? and (is_valid='Y' or is_valid is NULL) ";

    var userInput=[confirmationCode,spotId,date];

    runQueryWithParams(sqlValidate,userInput,callback);

}

//userInfo. (Json:  email,phone,last_name,first_name
//orderInfo (JsonArray: spot_id,valid_date,quantity_price)
exports.placeOrder = function(userInfo, orderInfoArray, confirmationCode, status, callback){

    console.log("confirmationCode:"+confirmationCode);
    var sqlInsertOrder = "insert into "+orderTable+" (email,phone,last_name,first_name,confirmation_code,order_status) values (?,?,?,?,?,?)";
    var sqlInsertTicket = "insert into "+ticketTable+" (confirmation_code,spot_id,valid_date,quantity,price,time) values (?,?,?,?,?,?) ";

    var userInput=[userInfo.email,userInfo.phone,userInfo.last_name,userInfo.first_name,confirmationCode,status];
    console.log("userInput--"+userInput);
    pool.getConnection(function(err,connection){
        if(err) {console.log(err); callback(0); return;}

        connection.query(sqlInsertOrder,userInput,function(err,info){
            if(err) {connection.rollback();console.log("transaction rolled back!");throw err;}
            console.log("info.affectedRows=" + info.affectedRows);



            if(info.affectedRows>0) {
                var count=0;
                console.log("o_length=" + orderInfoArray.length);
                for(var i=0;i<orderInfoArray.length;++i) {
                    var ticketInfo=[];
                    console.log("i=" + i);
                    ticketInfo[0]=confirmationCode;
                    ticketInfo[1]=orderInfoArray[i].spot_id;
                    ticketInfo[2]=orderInfoArray[i].valid_date;
                    ticketInfo[3]=orderInfoArray[i].quantity;
                    ticketInfo[4]=orderInfoArray[i].price;
                    ticketInfo[5]=orderInfoArray[i].time;
                    console.log("time=" + orderInfoArray[i].time);
                    connection.query(sqlInsertTicket,ticketInfo,function(err,info){
                        if(err){ connection.rollback();console.log("transaction rolled back!");throw err;}
                        callback(info.affectedRows);
                        ++count;
                        if(count==orderInfoArray.length) {
                            connection.release();
                            console.log("all transaction finished!");
                            callback(1);
                           // pool.end(function (err) {
                           //     if (err) console.error("An error occurred: " + err);
                           //     else console.log("My app terminated");
                           // });
                        }
                    })
                }
            }

            //connection.end();
        })
    })
}

exports.checkOrder=function(confirmationCode,callback) {
    var sqlCheckOrder = "select t_scenery_spots.name, t_orders.*,t_tickets_sold.* from t_tickets_sold,t_orders, t_scenery_spots where t_tickets_sold.confirmation_code = t_orders.confirmation_code and t_scenery_spots.spot_id= t_tickets_sold.spot_id and t_orders.confirmation_code = ? and is_valid='Y' ";
    console.log("sqlCheckOrder=" + sqlCheckOrder );
    runQueryWithParams(sqlCheckOrder,[confirmationCode],callback);

}

exports.checkInventory = function(spotId,date){
    var sqlCheckInventory = " select * from "+inventoryTable+" where spot_id=? and date=?";

    runQueryWithParams(sqlCheckInventory,[spotId,date],callback);

}
