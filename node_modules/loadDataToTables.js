/**
 * Created by XiTU on 1/27/14.
 */

var fs=require('fs');
var readline=require('readline');
var constants = require('./constants');
//var assert = require('assert');
var dbPool = require('./createDBConnectionPool');
var stringUtils = require('./stringUtils');
var tableNames = require('./tableNames');


//connection.query('CREATE database sctravel');
//connection.query('USE sctravel');


/**********************************************
 *
 * Read data from txt files
 *  according to the format given by params
 * Load the data read from file to
 *  our @tableName table in our DB
 *
 * @param tableColumnNames
 * @param tableColumnTypes
 * @param filePath
 * @param delimiter
 * @param tableName
 *
 *********************************************/
var loadDataFromTxtToTable = function( tableColumnNames, tableColumnTypes, filePath, delimiter, tableName) {

    var connection = dbPool.connection;
    //check the length of tableColumnNames and table ColumnTypes
    if(tableColumnNames.length != tableColumnTypes.length) {
        throw new Error("The length of tableColumnNames is "+ tableColumnNames.length+"; and the length of " +
            " tableColumnTypes is "+ tableColumnTypes.length+". They should be equal!");
    }


    console.log("splitting line by "+delimiter);

    var rd = readline.createInterface({
        input: fs.createReadStream(filePath),
        output: process.stdout,
        terminal: false
    });


    var processline = function(line) {

        var userInput = line.split(delimiter);

        //Convert the types from String to Number if necessary
        for(var i in tableColumnTypes) {

            var type = tableColumnTypes[i];
            if(type==constants.TYPE_NUMBER) {
                userInput[i] = Number(userInput[i]);
            } else if(type==constants.TYPE_STRING) {
                userInput[i]=userInput[i].trim();
            }
        }

        console.log(userInput);
        var insertSql = 'Insert into ' + tableName +
            ' ( ' + stringUtils.getDelimitedStringFromArray(tableColumnNames,',') +' ) VALUES ( ' +
                    stringUtils.getDelimitedRepeatString('?',',',tableColumnNames.length) + ' ) ' ;
        console.log(insertSql);
        connection.query( insertSql, userInput);
    }

    rd.on('line', function(line) {
        processline(line);
        console.log(line);
    });

    rd.on('close',function(){
       // connection.end();
    })


}


/***********************
 *
 * Loading data from txt
 *  file to our DB
 *
 * @type {string}
 **********************/

var spotsFilePath = '../data/scenery_spots.dat';
var spotsColumnNames=['spot_name','spot_type','longitude','latitude','city',  'address','post_code','phone', 'hours','is_scenery','is_start'];
var spotsColumnTypes=['STRING',   'STRING',   'NUMBER',   'NUMBER',  'STRING','STRING', 'STRING',   'STRING','STRING', 'STRING',  'STRING'];
//load data to sc_scenery_spots
loadDataFromTxtToTable(spotsColumnNames,spotsColumnTypes,spotsFilePath,',', tableNames.spotTable);

var routesFilePath = '../data/routes.dat';
var routesColumnNames=['departure_spot_id', 'arrival_spot_id', 'distance', 'travel_time_in_hours', 'route_description'];
var routesColumnTypes=['NUMBER','NUMBER','NUMBER','NUMBER','STRING'];
//load data to sc_sku_routes
loadDataFromTxtToTable(routesColumnNames,routesColumnTypes,routesFilePath,',', tableNames.routeTable);


var offersFilePath = '../data/offers.dat';
var offersColumnNames= ['offer_name','offer_price','offer_description'];
var offersColumnTypes= ['STRING','NUMBER','STRING'];
//load data to sc_offers
loadDataFromTxtToTable(offersColumnNames,offersColumnTypes,offersFilePath,',', tableNames.offerTable);


var offerSKUMappingFilePath = '../data/offer_sku_mappings.dat';
var offerSKUMappingColumnNames = ['offer_id','sku_id','sku_type'];
var offerSKUMappingColumnTypes = ['NUMBER','NUMBER','STRING'];
//load data to sc_sku_offer_mappings
loadDataFromTxtToTable(offerSKUMappingColumnNames,offerSKUMappingColumnTypes,offerSKUMappingFilePath,',',tableNames.mappingTable);

//rd.close();
//name, type, content, image, web_url, latitude, longtitude, city, address, phone, hours



